# Auto-merge PRs after Copilot/bot approval
# This workflow enables auto-merge when:
# 1. A PR receives an approval from Copilot or approved bots
# 2. All required status checks pass

name: Auto Merge

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run when review is approved OR check suite completed
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved') ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')

    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # For check_suite, find associated PR
            PR_NUMBER=$(gh api repos/${{ github.repository }}/commits/${{ github.event.check_suite.head_sha }}/pulls --jq '.[0].number' 2>/dev/null || echo "")
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for Copilot/bot approval
        id: check-approval
        if: steps.pr.outputs.number != ''
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}

          # Get all reviews for the PR
          REVIEWS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews)

          # Check if any approved review is from Copilot or github-actions bot
          # Copilot reviews appear as 'copilot' or through GitHub Actions
          APPROVED=$(echo "$REVIEWS" | jq -r '[.[] | select(.state == "APPROVED")] | length')

          # Check for bot approvals (copilot, github-actions, dependabot)
          BOT_APPROVED=$(echo "$REVIEWS" | jq -r '[.[] | select(.state == "APPROVED" and (.user.type == "Bot" or .user.login == "github-actions[bot]" or .user.login == "copilot[bot]" or .user.login == "dependabot[bot]"))] | length')

          echo "total_approvals=$APPROVED" >> $GITHUB_OUTPUT
          echo "bot_approvals=$BOT_APPROVED" >> $GITHUB_OUTPUT

          if [ "$APPROVED" -gt 0 ]; then
            echo "has_approval=true" >> $GITHUB_OUTPUT
          else
            echo "has_approval=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.check-approval.outputs.has_approval == 'true' && steps.pr.outputs.number != ''
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}

          echo "Enabling auto-merge for PR #$PR_NUMBER"

          # Enable auto-merge with squash
          gh pr merge $PR_NUMBER --auto --squash --repo ${{ github.repository }} || true

          echo "Auto-merge enabled successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.pr.outputs.number != ''
        run: |
          echo "### Auto-merge Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number:** #${{ steps.pr.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Approvals:** ${{ steps.check-approval.outputs.total_approvals }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bot Approvals:** ${{ steps.check-approval.outputs.bot_approvals }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Approval:** ${{ steps.check-approval.outputs.has_approval }}" >> $GITHUB_STEP_SUMMARY
