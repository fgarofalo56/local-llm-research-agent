# Docker Compose for Local LLM Research Agent
# SQL Server 2022 Developer Edition + Research Agent Application
#
# Project name: local-agent-ai-stack (all containers nested under this name)
#
# =============================================================================
# PROFILES - Choose what to start
# =============================================================================
#
# Profile           | Services Started                        | Use Case
# ------------------|----------------------------------------|----------------------------------
# (default)         | mssql, redis-stack, agent-ui           | Basic usage with Streamlit UI
# --profile api     | + api                                  | Add FastAPI backend
# --profile frontend| + api, frontend                        | Add React frontend (needs api)
# --profile cli     | + agent-cli                            | Add interactive CLI
# --profile full    | mssql, redis, agent-ui, api, frontend  | Everything (production-like)
# --profile init    | + mssql-tools                          | Database initialization
#
# =============================================================================
# QUICK START COMMANDS (run from project root with --env-file .env)
# =============================================================================
#
# First time setup:
#   docker volume create local-llm-mssql-data
#   docker volume create local-llm-redis-data
#   docker-compose -f docker/docker-compose.yml --env-file .env up -d
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile init up mssql-tools
#
# Start everything (including React frontend):
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile full up -d
#
# Start with API only:
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile api up -d
#
# Start with React frontend (includes API):
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile frontend up -d
#
# Run CLI interactively:
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile cli run --rm agent-cli
#
# Stop all:
#   docker-compose -f docker/docker-compose.yml down
#
# =============================================================================
# SERVICES OVERVIEW
# =============================================================================
#
# Service      | Container Name             | Port(s)         | Description
# -------------|----------------------------|-----------------|------------------------
# mssql        | local-agent-mssql          | 1433            | SQL Server 2022
# redis-stack  | local-agent-redis          | 6379, 8001*     | Redis + Vector Search
# agent-ui     | local-agent-streamlit-ui   | 8501            | Streamlit Web UI
# api          | local-agent-api            | 8000            | FastAPI Backend
# frontend     | local-agent-frontend       | 5173**          | React Frontend
# agent-cli    | local-agent-cli            | -               | Interactive CLI
# mssql-tools  | local-agent-mssql-tools    | -               | DB Init (runs once)
#
# * RedisInsight port configurable via REDIS_INSIGHT_PORT
# ** React frontend port configurable via FRONTEND_PORT
#
# =============================================================================
# CONNECTION DETAILS
# =============================================================================
#
# SQL Server:
#   Server: localhost,1433
#   Database: ResearchAnalytics
#   User: sa
#   Password: (see MSSQL_SA_PASSWORD in .env)
#
# Redis:
#   URL: redis://localhost:6379
#   RedisInsight GUI: http://localhost:8001 (or REDIS_INSIGHT_PORT)
#
# Web Interfaces:
#   React Frontend: http://localhost:5173 (or FRONTEND_PORT)
#   Streamlit UI:   http://localhost:8501
#   FastAPI Docs:   http://localhost:8000/docs
#   API Health:     http://localhost:8000/api/health
#
# =============================================================================
# ENVIRONMENT VARIABLES (via .env)
# =============================================================================
#
# Required:
#   MSSQL_SA_PASSWORD      - SQL Server SA password
#
# Optional (with defaults):
#   REDIS_PORT=6379        - Redis server port
#   REDIS_INSIGHT_PORT=8001- RedisInsight GUI port
#   API_PORT=8000          - FastAPI backend port
#   STREAMLIT_PORT=8501    - Streamlit UI port
#   OLLAMA_MODEL=qwen2.5:7b-instruct - LLM model to use
#
# =============================================================================
# DATA PERSISTENCE
# =============================================================================
#
# Volumes are EXTERNAL to preserve data across rebuilds:
#   - local-llm-mssql-data (SQL Server data)
#   - local-llm-redis-data (Redis data)
#
# IMPORTANT:
#   - "docker compose down" preserves data (safe)
#   - "docker compose down -v" DELETES all data (destructive)

name: local-agent-ai-stack

services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: local-agent-mssql
    hostname: mssql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      MSSQL_PID: "Developer"
      TZ: "America/New_York"
    ports:
      - "1433:1433"
    volumes:
      # Persist database files
      - mssql_data:/var/opt/mssql
      # Mount init scripts (executed manually or via setup script)
      - ./init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      # Note: Uses shell form to properly expand environment variable
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$$MSSQL_SA_PASSWORD" -No -Q "SELECT 1"
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - llm-network

  # Optional: SQL Server tools container for running scripts
  # Uses the same SQL Server image which includes sqlcmd tools
  mssql-tools:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: local-agent-mssql-tools
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
    volumes:
      - ./init:/scripts:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Waiting for SQL Server to be ready..."
        sleep 5
        echo "Running initialization scripts..."
        for script in /scripts/*.sql; do
          if [ -f "$$script" ]; then
            echo "Executing $$script..."
            /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "$$MSSQL_SA_PASSWORD" -No -i "$$script"
          fi
        done
        echo "Database initialization complete!"
    networks:
      - llm-network
    profiles:
      - init  # Only runs with: docker compose --profile init up

  # ==========================================================================
  # Research Agent Services
  # ==========================================================================

  # Agent Web UI (Streamlit)
  agent-ui:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: local-agent-streamlit-ui
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      # LLM Provider - connects to host Ollama instance
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      # SQL Server connection
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # MCP Configuration - use Python-based MCP server (supports SQL auth)
      MCP_MSSQL_PATH: python-mcp
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    command: ["streamlit", "run", "src/ui/streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
    restart: unless-stopped
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Agent CLI (run interactively)
  agent-cli:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: local-agent-cli
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      # LLM Provider - connects to host Ollama instance
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      # SQL Server connection
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # MCP Configuration - use Python-based MCP server (supports SQL auth)
      MCP_MSSQL_PATH: python-mcp
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
    stdin_open: true
    tty: true
    command: ["python", "-m", "src.cli.chat"]
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles:
      - cli  # Only runs with: docker compose --profile cli run agent-cli

  # ==========================================================================
  # Redis Stack for Vector Search
  # ==========================================================================

  redis-stack:
    image: redis/redis-stack:latest
    container_name: local-agent-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
      - "${REDIS_INSIGHT_PORT:-8001}:8001"  # RedisInsight GUI (change via REDIS_INSIGHT_PORT if port conflict)
    volumes:
      - redis_data:/data
    environment:
      REDIS_ARGS: "--save 60 1 --appendonly yes"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - llm-network

  # ==========================================================================
  # FastAPI Backend Service
  # ==========================================================================

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: local-agent-api
    depends_on:
      mssql:
        condition: service_healthy
      redis-stack:
        condition: service_healthy
    environment:
      # LLM Provider
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      EMBEDDING_MODEL: "${EMBEDDING_MODEL:-nomic-embed-text}"
      # SQL Server connection
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # Redis
      REDIS_URL: "redis://redis-stack:6379"
      # MCP Configuration - use Python-based MCP server (supports SQL auth)
      MCP_MSSQL_PATH: "python-mcp"
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      MCP_CONFIG_PATH: "/app/mcp_config.json"
      # RAG Settings
      CHUNK_SIZE: "${CHUNK_SIZE:-500}"
      CHUNK_OVERLAP: "${CHUNK_OVERLAP:-50}"
      RAG_TOP_K: "${RAG_TOP_K:-5}"
      # Storage
      UPLOAD_DIR: "/app/data/uploads"
      MAX_UPLOAD_SIZE_MB: "${MAX_UPLOAD_SIZE_MB:-100}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      DEBUG: "${DEBUG:-false}"
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ../data/uploads:/app/data/uploads
      - ../data/models:/app/data/models
      - ../mcp_config.json:/app/mcp_config.json:ro
    restart: unless-stopped
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles:
      - api   # Runs with: docker compose --profile api up
      - full  # Runs with: docker compose --profile full up

  # ==========================================================================
  # React Frontend Service
  # ==========================================================================

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: local-agent-frontend
    depends_on:
      - api
    ports:
      - "${FRONTEND_PORT:-5173}:80"
    restart: unless-stopped
    networks:
      - llm-network
    profiles:
      - frontend  # Runs with: docker compose --profile frontend up
      - full      # Runs with: docker compose --profile full up

volumes:
  mssql_data:
    # Use existing volume to preserve data from previous "docker" project
    # If you have data in local-llm-mssql-data, change this name to match
    # Or run: docker volume create local-agent-mssql-data
    #         docker run --rm -v local-llm-mssql-data:/from -v local-agent-mssql-data:/to alpine cp -av /from/. /to/
    name: ${MSSQL_VOLUME_NAME:-local-llm-mssql-data}
    external: true
  redis_data:
    name: ${REDIS_VOLUME_NAME:-local-llm-redis-data}
    external: true

networks:
  llm-network:
    name: local-agent-network
    driver: bridge
