# Docker Compose for Local LLM Research Agent
# SQL Server 2022 Developer Edition for local development/testing
#
# Usage:
#   docker compose up -d          # Start SQL Server
#   docker compose down           # Stop SQL Server
#   docker compose down -v        # Stop and remove data volumes
#   docker compose logs -f mssql  # View logs
#
# Connection:
#   Server: localhost,1433
#   Database: ResearchAnalytics
#   User: sa
#   Password: (see MSSQL_SA_PASSWORD below or .env)

services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: local-llm-mssql
    hostname: mssql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      MSSQL_PID: "Developer"
      TZ: "America/New_York"
    ports:
      - "1433:1433"
    volumes:
      # Persist database files
      - mssql_data:/var/opt/mssql
      # Mount init scripts (executed manually or via setup script)
      - ./init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -No -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - llm-network

  # Optional: SQL Server tools container for running scripts
  mssql-tools:
    image: mcr.microsoft.com/mssql-tools18
    container_name: local-llm-mssql-tools
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
    volumes:
      - ./init:/scripts:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Waiting for SQL Server to be ready..."
        sleep 5
        echo "Running initialization scripts..."
        for script in /scripts/*.sql; do
          if [ -f "$$script" ]; then
            echo "Executing $$script..."
            /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "$$MSSQL_SA_PASSWORD" -No -i "$$script"
          fi
        done
        echo "Database initialization complete!"
    networks:
      - llm-network
    profiles:
      - init  # Only runs with: docker compose --profile init up

volumes:
  mssql_data:
    name: local-llm-mssql-data

networks:
  llm-network:
    name: local-llm-network
    driver: bridge
