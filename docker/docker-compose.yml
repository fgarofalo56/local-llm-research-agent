# Docker Compose for Local LLM Research Agent
# SQL Server 2022 (Sample DB) + SQL Server 2025 (Backend) + Research Agent Application
#
# Project name: local-agent-ai-stack (all containers nested under this name)
#
# =============================================================================
# DATABASE ARCHITECTURE
# =============================================================================
#
# mssql (SQL Server 2022, Port 1433):
#   - ResearchAnalytics database - Sample/demo data for LLM queries
#   - Read-only sample data for demonstrating SQL Agent capabilities
#
# mssql-backend (SQL Server 2025, Port 1434):
#   - LLM_BackEnd database - Application state and configuration
#   - app schema: conversations, messages, dashboards, widgets, queries, etc.
#   - vectors schema: Native vector embeddings using SQL Server 2025 VECTOR type
#
# =============================================================================
# PROFILES - Choose what to start
# =============================================================================
#
# Profile           | Services Started                        | Use Case
# ------------------|----------------------------------------|----------------------------------
# (default)         | mssql, mssql-backend, agent-ui         | Basic usage with Streamlit UI
# --profile api     | + api                                  | Add FastAPI backend
# --profile frontend| + api, frontend                        | Add React frontend (needs api)
# --profile cli     | + agent-cli                            | Add interactive CLI
# --profile full    | All services including React frontend  | Everything (production-like)
# --profile init    | + mssql-tools, mssql-backend-tools     | Database initialization
#
# =============================================================================
# QUICK START COMMANDS (run from project root with --env-file .env)
# =============================================================================
#
# First time setup:
#   docker volume create local-llm-mssql-data
#   docker volume create local-llm-backend-data
#   docker-compose -f docker/docker-compose.yml --env-file .env up -d
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile init up mssql-tools
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile init up mssql-backend-tools
#
# Start everything (including React frontend):
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile full up -d
#
# Start with API only:
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile api up -d
#
# Start with React frontend (includes API):
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile frontend up -d
#
# Run CLI interactively:
#   docker-compose -f docker/docker-compose.yml --env-file .env --profile cli run --rm agent-cli
#
# Stop all:
#   docker-compose -f docker/docker-compose.yml down
#
# =============================================================================
# SERVICES OVERVIEW
# =============================================================================
#
# Service            | Container Name               | Port(s)     | Description
# -------------------|------------------------------|-------------|------------------------
# mssql              | local-agent-mssql            | 1433        | SQL Server 2022 (Sample DB)
# mssql-backend      | local-agent-mssql-backend    | 1434        | SQL Server 2025 (Backend)
# agent-ui           | local-agent-streamlit-ui     | 8501        | Streamlit Web UI
# api                | local-agent-api              | 8000        | FastAPI Backend
# frontend           | local-agent-frontend         | 5173*       | React Frontend
# agent-cli          | local-agent-cli              | -           | Interactive CLI
# mssql-tools        | local-agent-mssql-tools      | -           | Sample DB Init (runs once)
# mssql-backend-tools| local-agent-mssql-backend-tools | -        | Backend DB Init (runs once)
# superset           | local-agent-superset         | 8088        | Apache Superset BI
#
# * React frontend port configurable via FRONTEND_PORT
#
# =============================================================================
# CONNECTION DETAILS
# =============================================================================
#
# SQL Server 2022 (Sample Database):
#   Server: localhost,1433
#   Database: ResearchAnalytics
#   User: sa
#   Password: (see MSSQL_SA_PASSWORD in .env)
#
# SQL Server 2025 (Backend Database):
#   Server: localhost,1434
#   Database: LLM_BackEnd
#   User: sa
#   Password: (see MSSQL_SA_PASSWORD in .env)
#
# Web Interfaces:
#   React Frontend: http://localhost:5173 (or FRONTEND_PORT)
#   Streamlit UI:   http://localhost:8501
#   FastAPI Docs:   http://localhost:8000/docs
#   API Health:     http://localhost:8000/api/health
#   Superset BI:    http://localhost:8088
#
# =============================================================================
# ENVIRONMENT VARIABLES (via .env)
# =============================================================================
#
# Required:
#   MSSQL_SA_PASSWORD      - SQL Server SA password (both instances)
#
# Optional (with defaults):
#   API_PORT=8000          - FastAPI backend port
#   STREAMLIT_PORT=8501    - Streamlit UI port
#   OLLAMA_MODEL=qwen2.5:7b-instruct - LLM model to use
#   BACKEND_DB_PORT=1434   - SQL Server 2025 backend port
#
# =============================================================================
# DATA PERSISTENCE
# =============================================================================
#
# Volumes are EXTERNAL to preserve data across rebuilds:
#   - local-llm-mssql-data (SQL Server 2022 sample data)
#   - local-llm-backend-data (SQL Server 2025 backend data)
#
# IMPORTANT:
#   - "docker compose down" preserves data (safe)
#   - "docker compose down -v" DELETES all data (destructive)

name: local-agent-ai-stack

services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: local-agent-mssql
    hostname: mssql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      MSSQL_PID: "Developer"
      TZ: "America/New_York"
    ports:
      - "1433:1433"
    volumes:
      # Persist database files
      - mssql_data:/var/opt/mssql
      # Mount init scripts (executed manually or via setup script)
      - ./init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      # Note: Uses shell form to properly expand environment variable
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$$MSSQL_SA_PASSWORD" -No -Q "SELECT 1"
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - llm-network

  # Optional: SQL Server tools container for running scripts
  # Uses the same SQL Server image which includes sqlcmd tools
  mssql-tools:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: local-agent-mssql-tools
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
    volumes:
      - ./init:/scripts:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Waiting for SQL Server to be ready..."
        sleep 5
        echo "Running initialization scripts..."
        for script in /scripts/*.sql; do
          if [ -f "$$script" ]; then
            echo "Executing $$script..."
            /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "$$MSSQL_SA_PASSWORD" -No -i "$$script"
          fi
        done
        echo "Database initialization complete!"
    networks:
      - llm-network
    profiles:
      - init  # Only runs with: docker compose --profile init up

  # ==========================================================================
  # SQL Server 2025 - Backend Database with Native Vector Support
  # ==========================================================================
  # Stores application configuration, state, and vector embeddings
  # Uses SQL Server 2025's native VECTOR data type for similarity search

  mssql-backend:
    image: mcr.microsoft.com/mssql/server:2025-latest
    container_name: local-agent-mssql-backend
    hostname: mssql-backend
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      MSSQL_PID: "Developer"
      TZ: "America/New_York"
    ports:
      - "${BACKEND_DB_PORT:-1434}:1433"
    volumes:
      # Persist database files
      - backend_data:/var/opt/mssql
      # Mount init scripts for backend database
      - ./init-backend:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$$MSSQL_SA_PASSWORD" -No -Q "SELECT 1"
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - llm-network

  # SQL Server 2025 initialization tools container
  mssql-backend-tools:
    image: mcr.microsoft.com/mssql/server:2025-latest
    container_name: local-agent-mssql-backend-tools
    depends_on:
      mssql-backend:
        condition: service_healthy
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
    volumes:
      - ./init-backend:/scripts:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Waiting for SQL Server 2025 Backend to be ready..."
        sleep 5
        echo "Running LLM_BackEnd initialization scripts..."
        for script in /scripts/*.sql; do
          if [ -f "$$script" ]; then
            echo "Executing $$script..."
            /opt/mssql-tools18/bin/sqlcmd -S mssql-backend -U sa -P "$$MSSQL_SA_PASSWORD" -No -i "$$script"
          fi
        done
        echo "LLM_BackEnd database initialization complete!"
    networks:
      - llm-network
    profiles:
      - init  # Only runs with: docker compose --profile init up

  # ==========================================================================
  # Research Agent Services
  # ==========================================================================

  # Agent Web UI (Streamlit)
  # NOTE: For Documents/MCP pages to work, you need to also start the API service
  # Use: docker-compose --profile api up -d  OR  docker-compose --profile full up -d
  agent-ui:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: local-agent-streamlit-ui
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      # LLM Provider - connects to host Ollama instance
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      # SQL Server connection
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # MCP Configuration - use Python-based MCP server (supports SQL auth)
      MCP_MSSQL_PATH: python-mcp
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      # API connection (for Documents/MCP pages - requires --profile api)
      API_HOST: "api"  # Docker container name for API service
      API_PORT: "${API_PORT:-8000}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    command: ["streamlit", "run", "src/ui/streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
    restart: unless-stopped
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Agent CLI (run interactively)
  agent-cli:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: local-agent-cli
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      # LLM Provider - connects to host Ollama instance
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      # SQL Server connection
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # MCP Configuration - use Python-based MCP server (supports SQL auth)
      MCP_MSSQL_PATH: python-mcp
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
    stdin_open: true
    tty: true
    command: ["python", "-m", "src.cli.chat"]
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles:
      - cli  # Only runs with: docker compose --profile cli run agent-cli

  # ==========================================================================
  # Redis Stack for Vector Search
  # ==========================================================================

  redis-stack:
    image: redis/redis-stack:latest
    container_name: local-agent-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
      - "${REDIS_INSIGHT_PORT:-8001}:8001"  # RedisInsight GUI (change via REDIS_INSIGHT_PORT if port conflict)
    volumes:
      - redis_data:/data
    environment:
      REDIS_ARGS: "--save 60 1 --appendonly yes"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - llm-network

  # ==========================================================================
  # FastAPI Backend Service
  # ==========================================================================

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: local-agent-api
    depends_on:
      mssql:
        condition: service_healthy
      mssql-backend:
        condition: service_healthy
      redis-stack:
        condition: service_healthy
    environment:
      # LLM Provider
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      EMBEDDING_MODEL: "${EMBEDDING_MODEL:-nomic-embed-text}"
      # SQL Server 2022 - Sample Database (ResearchAnalytics)
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # SQL Server 2025 - Backend Database (LLM_BackEnd with native vectors)
      BACKEND_DB_HOST: mssql-backend
      BACKEND_DB_PORT: "1433"
      BACKEND_DB_NAME: "LLM_BackEnd"
      BACKEND_DB_USERNAME: sa
      BACKEND_DB_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      BACKEND_DB_TRUST_CERT: "true"
      # Vector Store Configuration
      VECTOR_STORE_TYPE: "${VECTOR_STORE_TYPE:-mssql}"  # mssql (SQL Server 2025) or redis
      VECTOR_DIMENSIONS: "768"  # nomic-embed-text dimensions
      # Redis (for caching, optional vector fallback)
      REDIS_URL: "redis://redis-stack:6379"
      # MCP Configuration - use Python-based MCP server (supports SQL auth)
      MCP_MSSQL_PATH: "python-mcp"
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      MCP_CONFIG_PATH: "/app/mcp_config.json"
      # RAG Settings
      CHUNK_SIZE: "${CHUNK_SIZE:-500}"
      CHUNK_OVERLAP: "${CHUNK_OVERLAP:-50}"
      RAG_TOP_K: "${RAG_TOP_K:-5}"
      # Storage
      UPLOAD_DIR: "/app/data/uploads"
      MAX_UPLOAD_SIZE_MB: "${MAX_UPLOAD_SIZE_MB:-100}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      DEBUG: "${DEBUG:-false}"
      # Superset connection (for API to call Superset)
      SUPERSET_URL: "http://superset:8088"
      SUPERSET_ADMIN_USER: "${SUPERSET_ADMIN_USER:-admin}"
      SUPERSET_ADMIN_PASSWORD: "${SUPERSET_ADMIN_PASSWORD:-LocalLLM@2024!}"
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ../data/uploads:/app/data/uploads
      - ../data/models:/app/data/models
      - ../mcp_config.json:/app/mcp_config.json:ro
    restart: unless-stopped
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles:
      - api   # Runs with: docker compose --profile api up
      - full  # Runs with: docker compose --profile full up

  # ==========================================================================
  # React Frontend Service
  # ==========================================================================

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: local-agent-frontend
    depends_on:
      - api
    ports:
      - "${FRONTEND_PORT:-5173}:80"
    restart: unless-stopped
    networks:
      - llm-network
    profiles:
      - frontend  # Runs with: docker compose --profile frontend up
      - full      # Runs with: docker compose --profile full up

  # ==========================================================================
  # Apache Superset - Enterprise BI Platform
  # ==========================================================================
  # Phase 3: Provides SQL Lab, scheduled reports, and embeddable dashboards
  # Access at http://localhost:8088 with admin credentials from .env

  superset:
    build:
      context: .
      dockerfile: Dockerfile.superset
    container_name: local-agent-superset
    depends_on:
      mssql:
        condition: service_healthy
      redis-stack:
        condition: service_healthy
    environment:
      SUPERSET_SECRET_KEY: "${SUPERSET_SECRET_KEY:-localllm_default_secret_key_change_me_in_production}"
      SUPERSET_ADMIN_PASSWORD: "${SUPERSET_ADMIN_PASSWORD:-LocalLLM@2024!}"
      SQLALCHEMY_DATABASE_URI: "sqlite:////app/superset_home/superset.db"
      SUPERSET_LOAD_EXAMPLES: "no"
      REDIS_HOST: "redis-stack"
      REDIS_PORT: "6379"
      # Pass SQL Server credentials for datasource setup script
      MSSQL_HOST: "mssql"
      MSSQL_PORT: "1433"
      MSSQL_DATABASE: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
    ports:
      - "${SUPERSET_PORT:-8088}:8088"
    volumes:
      - superset_home:/app/superset_home
      - ./superset/superset_config.py:/app/pythonpath/superset_config.py:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    command: >
      bash -c "
        superset db upgrade &&
        superset fab create-admin --username admin --firstname Admin --lastname User --email admin@local.llm --password $${SUPERSET_ADMIN_PASSWORD} || true &&
        superset init &&
        superset run -h 0.0.0.0 -p 8088 --with-threads --reload
      "
    restart: unless-stopped
    networks:
      - llm-network
    profiles:
      - superset   # Runs with: docker compose --profile superset up
      - full       # Runs with: docker compose --profile full up

volumes:
  mssql_data:
    # SQL Server 2022 - Sample ResearchAnalytics database
    # Use existing volume to preserve data from previous "docker" project
    # If you have data in local-llm-mssql-data, change this name to match
    # Or run: docker volume create local-agent-mssql-data
    #         docker run --rm -v local-llm-mssql-data:/from -v local-agent-mssql-data:/to alpine cp -av /from/. /to/
    name: ${MSSQL_VOLUME_NAME:-local-llm-mssql-data}
    external: true
  backend_data:
    # SQL Server 2025 - LLM_BackEnd application database with native vector support
    # Create with: docker volume create local-llm-backend-data
    name: ${BACKEND_VOLUME_NAME:-local-llm-backend-data}
    external: true
  redis_data:
    name: ${REDIS_VOLUME_NAME:-local-llm-redis-data}
    external: true
  superset_home:
    name: ${SUPERSET_VOLUME_NAME:-local-llm-superset-data}

networks:
  llm-network:
    name: local-agent-network
    driver: bridge
