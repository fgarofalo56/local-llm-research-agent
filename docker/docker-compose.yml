# Docker Compose for Local LLM Research Agent
# SQL Server 2022 Developer Edition + Research Agent Application
#
# Project name: local-agent-ai-stack (all containers nested under this name)
#
# Usage:
#   docker compose up -d              # Start SQL Server only
#   docker compose up -d agent-ui     # Start agent web UI
#   docker compose run agent-cli      # Run interactive CLI
#   docker compose --profile init up  # Initialize database
#   docker compose down               # Stop all services
#   docker compose down -v            # Stop and remove data volumes
#
# Services:
#   mssql       - SQL Server database (always starts)
#   agent-ui    - Streamlit web interface (port 8501)
#   agent-cli   - Interactive CLI chat (run manually)
#   mssql-tools - Database initialization (profile: init)
#   redis-stack - Redis with vector search (port 6379, RedisInsight on 8001)
#   api         - FastAPI backend (port 8000)
#
# Connection:
#   Server: localhost,1433
#   Database: ResearchAnalytics
#   User: sa
#   Password: (see MSSQL_SA_PASSWORD below or .env)
#
# Port Configuration (via .env):
#   REDIS_PORT=6379          # Redis server port
#   REDIS_INSIGHT_PORT=8001  # RedisInsight GUI port (change if 8001 is in use)
#   API_PORT=8000            # FastAPI backend port
#   STREAMLIT_PORT=8501      # Streamlit UI port
#
# Data Persistence:
#   Volumes are configured as EXTERNAL to preserve data across rebuilds.
#   Default volume names: local-llm-mssql-data, local-llm-redis-data
#   To use different volumes, set in .env:
#     MSSQL_VOLUME_NAME=your-mssql-volume
#     REDIS_VOLUME_NAME=your-redis-volume
#
#   IMPORTANT:
#     - "docker compose down" preserves data (safe)
#     - "docker compose down -v" DELETES all data (destructive)

name: local-agent-ai-stack

services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: local-agent-mssql
    hostname: mssql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      MSSQL_PID: "Developer"
      TZ: "America/New_York"
    ports:
      - "1433:1433"
    volumes:
      # Persist database files
      - mssql_data:/var/opt/mssql
      # Mount init scripts (executed manually or via setup script)
      - ./init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -No -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - llm-network

  # Optional: SQL Server tools container for running scripts
  # Uses the same SQL Server image which includes sqlcmd tools
  mssql-tools:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: local-agent-mssql-tools
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
    volumes:
      - ./init:/scripts:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Waiting for SQL Server to be ready..."
        sleep 5
        echo "Running initialization scripts..."
        for script in /scripts/*.sql; do
          if [ -f "$$script" ]; then
            echo "Executing $$script..."
            /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "$$MSSQL_SA_PASSWORD" -No -i "$$script"
          fi
        done
        echo "Database initialization complete!"
    networks:
      - llm-network
    profiles:
      - init  # Only runs with: docker compose --profile init up

  # ==========================================================================
  # Research Agent Services
  # ==========================================================================

  # Agent Web UI (Streamlit)
  agent-ui:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: local-agent-streamlit-ui
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      # LLM Provider - connects to host Ollama instance
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      # SQL Server connection
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # MCP Configuration
      MCP_MSSQL_PATH: /opt/mssql-mcp/dist/index.js
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    command: ["streamlit", "run", "src/ui/streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
    restart: unless-stopped
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Agent CLI (run interactively)
  agent-cli:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: local-agent-cli
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      # LLM Provider - connects to host Ollama instance
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      # SQL Server connection
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # MCP Configuration
      MCP_MSSQL_PATH: /opt/mssql-mcp/dist/index.js
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
    stdin_open: true
    tty: true
    command: ["python", "-m", "src.cli.chat"]
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles:
      - cli  # Only runs with: docker compose --profile cli run agent-cli

  # ==========================================================================
  # Redis Stack for Vector Search
  # ==========================================================================

  redis-stack:
    image: redis/redis-stack:latest
    container_name: local-agent-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
      - "${REDIS_INSIGHT_PORT:-8001}:8001"  # RedisInsight GUI (change via REDIS_INSIGHT_PORT if port conflict)
    volumes:
      - redis_data:/data
    environment:
      REDIS_ARGS: "--save 60 1 --appendonly yes"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - llm-network

  # ==========================================================================
  # FastAPI Backend Service
  # ==========================================================================

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: local-agent-api
    depends_on:
      mssql:
        condition: service_healthy
      redis-stack:
        condition: service_healthy
    environment:
      # LLM Provider
      LLM_PROVIDER: "${LLM_PROVIDER:-ollama}"
      OLLAMA_HOST: "${OLLAMA_HOST:-http://host.docker.internal:11434}"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:7b-instruct}"
      EMBEDDING_MODEL: "${EMBEDDING_MODEL:-nomic-embed-text}"
      # SQL Server connection
      SQL_SERVER_HOST: mssql
      SQL_SERVER_PORT: "1433"
      SQL_DATABASE_NAME: "${SQL_DATABASE_NAME:-ResearchAnalytics}"
      SQL_USERNAME: sa
      SQL_PASSWORD: "${MSSQL_SA_PASSWORD:-LocalLLM@2024!}"
      SQL_TRUST_SERVER_CERTIFICATE: "true"
      # Redis
      REDIS_URL: "redis://redis-stack:6379"
      # MCP Configuration
      MCP_MSSQL_PATH: /opt/mssql-mcp/dist/index.js
      MCP_MSSQL_READONLY: "${MCP_MSSQL_READONLY:-false}"
      MCP_CONFIG_PATH: "/app/mcp_config.json"
      # RAG Settings
      CHUNK_SIZE: "${CHUNK_SIZE:-500}"
      CHUNK_OVERLAP: "${CHUNK_OVERLAP:-50}"
      RAG_TOP_K: "${RAG_TOP_K:-5}"
      # Storage
      UPLOAD_DIR: "/app/data/uploads"
      MAX_UPLOAD_SIZE_MB: "${MAX_UPLOAD_SIZE_MB:-100}"
      # Application settings
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      DEBUG: "${DEBUG:-false}"
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ../data/uploads:/app/data/uploads
      - ../data/models:/app/data/models
      - ../mcp_config.json:/app/mcp_config.json:ro
    restart: unless-stopped
    networks:
      - llm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles:
      - api  # Only runs with: docker compose --profile api up

volumes:
  mssql_data:
    # Use existing volume to preserve data from previous "docker" project
    # If you have data in local-llm-mssql-data, change this name to match
    # Or run: docker volume create local-agent-mssql-data
    #         docker run --rm -v local-llm-mssql-data:/from -v local-agent-mssql-data:/to alpine cp -av /from/. /to/
    name: ${MSSQL_VOLUME_NAME:-local-llm-mssql-data}
    external: true
  redis_data:
    name: ${REDIS_VOLUME_NAME:-local-llm-redis-data}
    external: true

networks:
  llm-network:
    name: local-agent-network
    driver: bridge
